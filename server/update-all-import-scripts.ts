import { db } from './db.js';
import { activities, activityBudgetProposals } from '../shared/schema.js';
import { sql } from 'drizzle-orm';

// Script to fix and update all activity import scripts for MySQL compatibility
async function updateAllImportScripts() {
  console.log("üîß Atualizando todos os scripts de importa√ß√£o para MySQL...");
  
  // London Activities with MySQL-compatible fields
  const londonActivities = [
    {
      title: "London Eye - Roda Gigante Ic√¥nica",
      description: "Desfrute de vistas panor√¢micas espetaculares de Londres a 135 metros de altura! O London Eye √© a roda gigante de observa√ß√£o mais alta da Europa.",
      location: "Londres, Reino Unido",
      category: "sightseeing",
      countryType: "internacional",
      region: "Europa Ocidental",
      city: "Londres",
      priceType: "per_person",
      priceAmount: null,
      duration: "30-45 minutos",
      difficultyLevel: "easy",
      minParticipants: 1,
      maxParticipants: 25,
      languages: ["Ingl√™s", "Espanhol", "Franc√™s", "Alem√£o", "Italiano", "Portugu√™s"],
      inclusions: ["Entrada no London Eye", "Volta completa de 30 min", "Vistas panor√¢micas", "Audioguia digital"],
      exclusions: ["Transporte", "Alimenta√ß√£o", "Fotografias", "Souvenirs", "Champagne"],
      requirements: ["Chegada 15 min antes", "Crian√ßas menores 16 anos com adulto", "N√£o recomendado para claustrofobia"],
      cancellationPolicy: "Cancelamento gratuito at√© 24h antes da visita",
      contactInfo: {
        phone: "+44 871 781 3000",
        email: "info@londoneye.com",
        website: "https://www.londoneye.com",
        address: "Riverside Building, County Hall, London SE1 7PB"
      },
      coverImage: "https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?w=1200&h=800&fit=crop&q=85",
      images: [
        "https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?w=1200&h=800&fit=crop&q=85",
        "https://images.unsplash.com/photo-1529655683826-aba9b3e77383?w=1200&h=800&fit=crop&q=85"
      ],
      averageRating: 4.5,
      totalRatings: 1250,
      isActive: true,
      createdById: 1
    },
    {
      title: "Torre de Londres - Fortaleza Hist√≥rica",
      description: "Explore quase 1.000 anos de hist√≥ria real na Torre de Londres! Esta fortaleza hist√≥rica abriga as mundialmente famosas Joias da Coroa.",
      location: "Londres, Reino Unido",
      category: "culture",
      countryType: "internacional",
      region: "Europa Ocidental",
      city: "Londres",
      priceType: "per_person",
      priceAmount: null,
      duration: "2-3 horas",
      difficultyLevel: "easy",
      minParticipants: 1,
      maxParticipants: 50,
      languages: ["Ingl√™s", "Franc√™s", "Alem√£o", "Espanhol", "Italiano"],
      inclusions: ["Entrada na Torre", "Acesso √†s Joias da Coroa", "White Tower", "Yeoman Warder tours", "Audioguia"],
      exclusions: ["Transporte", "Alimenta√ß√£o", "Fotografias nas Joias", "Souvenirs"],
      requirements: ["Documento de identidade", "Inspe√ß√£o de seguran√ßa", "N√£o permitido bagagem grande"],
      cancellationPolicy: "Cancelamento gratuito at√© 24h antes da visita",
      contactInfo: {
        phone: "+44 20 3166 6000",
        email: "toweroflondon@hrp.org.uk",
        website: "https://www.hrp.org.uk/tower-of-london",
        address: "St Katharine's & Wapping, London EC3N 4AB"
      },
      coverImage: "https://images.unsplash.com/photo-1539037116277-4db20889f2d4?w=1200&h=800&fit=crop&q=85",
      images: [
        "https://images.unsplash.com/photo-1539037116277-4db20889f2d4?w=1200&h=800&fit=crop&q=85",
        "https://images.unsplash.com/photo-1548013146-72479768bada?w=1200&h=800&fit=crop&q=85"
      ],
      averageRating: 4.6,
      totalRatings: 980,
      isActive: true,
      createdById: 1
    },
    {
      title: "Museu Brit√¢nico - Tesouros Mundiais",
      description: "Descubra a hist√≥ria da humanidade no Museu Brit√¢nico! Veja tesouros √∫nicos como a Pedra de Rosetta, m√∫mias eg√≠pcias e esculturas do Partenon.",
      location: "Londres, Reino Unido",
      category: "culture",
      countryType: "internacional",
      region: "Europa Ocidental",
      city: "Londres",
      priceType: "per_person",
      priceAmount: null,
      duration: "2-4 horas",
      difficultyLevel: "easy",
      minParticipants: 1,
      maxParticipants: 100,
      languages: ["Ingl√™s", "Espanhol", "Franc√™s", "Alem√£o", "Italiano", "Japon√™s", "Chin√™s"],
      inclusions: ["Entrada gratuita", "Acesso a galerias permanentes", "Mapa do museu", "WiFi gratuito"],
      exclusions: ["Exposi√ß√µes especiais", "Audioguia", "Tours guiados", "Alimenta√ß√£o", "Estacionamento"],
      requirements: ["Inspe√ß√£o de seguran√ßa", "N√£o permitido mochilas grandes", "Fotografias sem flash"],
      cancellationPolicy: "Entrada gratuita - sem cancelamento necess√°rio",
      contactInfo: {
        phone: "+44 20 7323 8299",
        email: "information@britishmuseum.org",
        website: "https://www.britishmuseum.org",
        address: "Great Russell St, Bloomsbury, London WC1B 3DG"
      },
      coverImage: "https://images.unsplash.com/photo-1555504874-7c6e3e7c4e5e?w=1200&h=800&fit=crop&q=85",
      images: [
        "https://images.unsplash.com/photo-1555504874-7c6e3e7c4e5e?w=1200&h=800&fit=crop&q=85",
        "https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?w=1200&h=800&fit=crop&q=85"
      ],
      averageRating: 4.7,
      totalRatings: 2100,
      isActive: true,
      createdById: 1
    },
    {
      title: "West End - Teatro de Classe Mundial",
      description: "Experimente a magia dos teatros do West End de Londres! Assista aos melhores musicais e pe√ßas teatrais do mundo em teatros hist√≥ricos.",
      location: "Londres, Reino Unido",
      category: "culture",
      countryType: "internacional",
      region: "Europa Ocidental",
      city: "Londres",
      priceType: "per_person",
      priceAmount: null,
      duration: "2-3 horas",
      difficultyLevel: "easy",
      minParticipants: 1,
      maxParticipants: 2000,
      languages: ["Ingl√™s"],
      inclusions: ["Ingresso para o espet√°culo", "Programa da pe√ßa", "Acesso ao teatro"],
      exclusions: ["Transporte", "Alimenta√ß√£o", "Bebidas", "Gorjetas", "Meet & Greet"],
      requirements: ["Chegada 30 min antes", "Traje elegante recomendado", "Crian√ßas verificar classifica√ß√£o"],
      cancellationPolicy: "Pol√≠tica varia por teatro - verificar condi√ß√µes",
      contactInfo: {
        phone: "+44 84 4871 7622",
        email: "info@theatreland.com",
        website: "https://www.londontheatre.co.uk",
        address: "West End, London"
      },
      coverImage: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=1200&h=800&fit=crop&q=85",
      images: [
        "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=1200&h=800&fit=crop&q=85",
        "https://images.unsplash.com/photo-1581833971358-2c8b550f87b3?w=1200&h=800&fit=crop&q=85"
      ],
      averageRating: 4.8,
      totalRatings: 850,
      isActive: true,
      createdById: 1
    },
    {
      title: "Pal√°cio de Buckingham - Resid√™ncia Real",
      description: "Visite a resid√™ncia oficial da Rainha e assista √† famosa cerim√¥nia da Troca da Guarda. Explore os State Rooms durante o ver√£o.",
      location: "Londres, Reino Unido",
      category: "sightseeing",
      countryType: "internacional",
      region: "Europa Ocidental",
      city: "Londres",
      priceType: "per_person",
      priceAmount: null,
      duration: "1-2 horas",
      difficultyLevel: "easy",
      minParticipants: 1,
      maxParticipants: 5000,
      languages: ["Ingl√™s", "Espanhol", "Franc√™s", "Alem√£o", "Italiano", "Japon√™s"],
      inclusions: ["Vista externa", "Cerim√¥nia Troca da Guarda", "Jardins St. James", "Fotografias"],
      exclusions: ["Acesso interno", "State Rooms", "Audioguia", "Transporte", "Alimenta√ß√£o"],
      requirements: ["Chegada cedo para melhores lugares", "Verificar hor√°rios da cerim√¥nia", "Respeitar protocolos"],
      cancellationPolicy: "Evento gratuito - sujeito a condi√ß√µes clim√°ticas",
      contactInfo: {
        phone: "+44 30 3123 7300",
        email: "bookinginfo@royalcollection.org.uk",
        website: "https://www.rct.uk/visit/buckingham-palace",
        address: "Buckingham Palace, London SW1A 1AA"
      },
      coverImage: "https://images.unsplash.com/photo-1533929736458-ca588d08c8be?w=1200&h=800&fit=crop&q=85",
      images: [
        "https://images.unsplash.com/photo-1533929736458-ca588d08c8be?w=1200&h=800&fit=crop&q=85",
        "https://images.unsplash.com/photo-1580479452314-f7d7e8b53db8?w=1200&h=800&fit=crop&q=85"
      ],
      averageRating: 4.3,
      totalRatings: 1680,
      isActive: true,
      createdById: 1
    }
  ];

  // Budget proposals for London activities
  const londonBudgetProposals = [
    {
      activityTitle: "London Eye - Roda Gigante Ic√¥nica",
      proposals: [
        {
          title: "Econ√¥mico - Ingresso Padr√£o",
          description: "Ingresso padr√£o para a roda gigante London Eye durante hor√°rios regulares.",
          amount: 27.00,
          currency: "GBP",
          inclusions: ["Entrada London Eye", "Volta completa 30 min", "Vista panor√¢mica", "Acesso padr√£o"],
          exclusions: ["Fast Track", "Champagne", "Fotografias", "Guia privado", "Hor√°rio premium"]
        },
        {
          title: "Completo - Fast Track + Experi√™ncia",
          description: "Entrada r√°pida com experi√™ncia aprimorada e acesso priorit√°rio.",
          amount: 37.00,
          currency: "GBP",
          inclusions: ["Fast Track", "Entrada priorit√°ria", "Brochura informativa", "Desconto loja", "Vista premium"],
          exclusions: ["Champagne", "Fotografias profissionais", "Guia privado", "Transfer"]
        },
        {
          title: "Premium - Champagne Experience",
          description: "Experi√™ncia VIP com champagne e acesso exclusivo ao compartimento privado.",
          amount: 45.00,
          currency: "GBP",
          inclusions: ["Compartimento privado", "Ta√ßa de champagne", "Fast Track", "Fotografias", "Brinde especial"],
          exclusions: ["Transfer privado", "Jantar", "M√∫ltiplas voltas", "Guia pessoal"]
        }
      ]
    },
    {
      activityTitle: "Torre de Londres - Fortaleza Hist√≥rica",
      proposals: [
        {
          title: "Econ√¥mico - Entrada Padr√£o",
          description: "Entrada geral para a Torre de Londres com acesso √†s principais atra√ß√µes.",
          amount: 29.90,
          currency: "GBP",
          inclusions: ["Entrada geral", "Joias da Coroa", "White Tower", "Yeoman Warder tours", "Audioguia b√°sico"],
          exclusions: ["Tours privados", "Experi√™ncias especiais", "Fotografias profissionais", "Souvenirs"]
        },
        {
          title: "Completo - Tour Hist√≥rico Guiado",
          description: "Tour completo com guia especializado e acesso a √°reas especiais.",
          amount: 42.00,
          currency: "GBP",
          inclusions: ["Tour guiado", "Acesso especial", "Hist√≥ria detalhada", "Mapa premium", "Beefeater interaction"],
          exclusions: ["Tour privado", "Alimenta√ß√£o", "Transfer", "Fotografias profissionais"]
        },
        {
          title: "Premium - Experi√™ncia VIP Completa",
          description: "Acesso VIP com tour privado e experi√™ncias exclusivas na Torre de Londres.",
          amount: 85.00,
          currency: "GBP",
          inclusions: ["Tour privado", "Acesso VIP", "Behind-the-scenes", "Fotografias inclu√≠das", "Brinde exclusivo"],
          exclusions: ["Transfer privado", "Refei√ß√µes", "Hospedagem", "Experi√™ncias noturnas"]
        }
      ]
    },
    {
      activityTitle: "Museu Brit√¢nico - Tesouros Mundiais",
      proposals: [
        {
          title: "Econ√¥mico - Entrada Gratuita",
          description: "Entrada gratuita para explorar as cole√ß√µes permanentes do museu.",
          amount: 0.00,
          currency: "GBP",
          inclusions: ["Entrada gratuita", "Cole√ß√µes permanentes", "Mapa b√°sico", "WiFi", "Acesso geral"],
          exclusions: ["Audioguia", "Tours guiados", "Exposi√ß√µes especiais", "Workshops", "Souvenirs"]
        },
        {
          title: "Completo - Tour com Audioguia",
          description: "Experi√™ncia aprimorada com audioguia e acesso a exposi√ß√µes especiais.",
          amount: 7.00,
          currency: "GBP",
          inclusions: ["Audioguia multil√≠ngue", "Highlights tour", "Mapa detalhado", "App m√≥vel", "Dicas especiais"],
          exclusions: ["Tour privado", "Workshops", "Palestras", "Behind-the-scenes", "Certificado"]
        },
        {
          title: "Premium - Tour Privado Especializado",
          description: "Tour privado com curador especializado e acesso a √°reas restritas.",
          amount: 150.00,
          currency: "GBP",
          inclusions: ["Tour privado", "Curador especializado", "Acesso restrito", "Certificado", "Behind-the-scenes"],
          exclusions: ["Transfer", "Refei√ß√µes", "Hospedagem", "M√∫ltiplas visitas", "Workshops externos"]
        }
      ]
    },
    {
      activityTitle: "West End - Teatro de Classe Mundial",
      proposals: [
        {
          title: "Econ√¥mico - Assentos Padr√£o",
          description: "Ingressos para assentos padr√£o em teatros do West End com boa visibilidade.",
          amount: 25.00,
          currency: "GBP",
          inclusions: ["Ingresso espet√°culo", "Assento padr√£o", "Programa", "Acesso teatro", "Vista do palco"],
          exclusions: ["Assentos premium", "Bebidas", "Transfer", "Meet & greet", "Bastidores"]
        },
        {
          title: "Completo - Assentos Premium + Intervalo",
          description: "Assentos premium com bebida no intervalo e programa especial.",
          amount: 65.00,
          currency: "GBP",
          inclusions: ["Assentos premium", "Bebida intervalo", "Programa especial", "Vista excelente", "Prioridade entrada"],
          exclusions: ["Jantar", "Transfer", "Meet & greet", "Bastidores", "Fotografias"]
        },
        {
          title: "Premium - Experi√™ncia VIP Completa",
          description: "Experi√™ncia VIP com melhores assentos, jantar e encontro com elenco.",
          amount: 180.00,
          currency: "GBP",
          inclusions: ["Melhores assentos", "Jantar pr√©-show", "Meet & greet", "Bastidores", "Champagne", "Fotografias"],
          exclusions: ["Transfer privado", "Hospedagem", "M√∫ltiplos shows", "Aut√≥grafos garantidos"]
        }
      ]
    },
    {
      activityTitle: "Pal√°cio de Buckingham - Resid√™ncia Real",
      proposals: [
        {
          title: "Econ√¥mico - Evento Externo",
          description: "Assista √† cerim√¥nia da Troca da Guarda gratuitamente do lado externo.",
          amount: 0.00,
          currency: "GBP",
          inclusions: ["Troca da Guarda", "Vista externa", "Evento gratuito", "Atmosfera real", "Fotografias"],
          exclusions: ["Acesso interno", "Guia tur√≠stico", "State Rooms", "Jardins", "Audioguia"]
        },
        {
          title: "Completo - Tour Externo Guiado",
          description: "Tour guiado externo com contexto hist√≥rico e melhores pontos de vista.",
          amount: 25.00,
          currency: "GBP",
          inclusions: ["Tour externo", "Guia especializado", "Troca da Guarda", "Hist√≥ria real", "Melhores vistas"],
          exclusions: ["Acesso interno", "State Rooms", "Jardins", "Alimenta√ß√£o", "Transfer"]
        },
        {
          title: "Premium - Tour Interno + State Rooms",
          description: "Tour interno exclusivo dos State Rooms com arte da Royal Collection (apenas ver√£o).",
          amount: 30.00,
          currency: "GBP",
          inclusions: ["State Rooms", "Royal Collection", "Jardins", "Audioguia", "Acesso exclusivo"],
          exclusions: ["Quartos privados", "Transfer", "Alimenta√ß√£o", "Fotografias internas", "Tours privados"]
        }
      ]
    }
  ];

  try {
    console.log("üè∞ Adicionando atividades de Londres...");

    // Insert London activities
    for (const activity of londonActivities) {
      try {
        const result = await db.insert(activities).values(activity);
        console.log(`‚úÖ Atividade criada: ${activity.title}`);
      } catch (error: any) {
        if (error.code === 'ER_DUP_ENTRY') {
          console.log(`‚ÑπÔ∏è Atividade j√° existe: ${activity.title}`);
        } else {
          console.error(`‚ùå Erro ao criar ${activity.title}:`, error.message);
        }
      }
    }

    // Insert budget proposals
    for (const budgetGroup of londonBudgetProposals) {
      const activity = await db.select()
        .from(activities)
        .where(sql`title = ${budgetGroup.activityTitle}`)
        .limit(1);

      if (activity.length > 0) {
        for (const proposal of budgetGroup.proposals) {
          try {
            await db.insert(activityBudgetProposals).values({
              activityId: activity[0].id,
              createdBy: 1,
              title: proposal.title,
              description: proposal.description,
              amount: proposal.amount.toString(),
              currency: proposal.currency,
              inclusions: JSON.stringify(proposal.inclusions),
              exclusions: JSON.stringify(proposal.exclusions),
              isActive: true
            });
            console.log(`  üí∞ Proposta criada: ${proposal.title}`);
          } catch (proposalError: any) {
            if (proposalError.code === 'ER_DUP_ENTRY') {
              console.log(`  ‚ÑπÔ∏è Proposta j√° existe: ${proposal.title}`);
            } else {
              console.error(`  ‚ùå Erro ao criar proposta:`, proposalError.message);
            }
          }
        }
      }
    }

    console.log("üéâ Atividades de Londres criadas com sucesso!");
    return true;

  } catch (error) {
    console.error("‚ùå Erro geral:", error);
    return false;
  }
}

if (import.meta.url === `file://${process.argv[1]}`) {
  updateAllImportScripts().then(() => process.exit(0));
}

export { updateAllImportScripts };